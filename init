#!/bin/sh

/bin/mkdir -p /dev/
/bin/mount -t devtmpfs devtmpfs /dev

/bin/echo "Aether-OS init script is running..."

/bin/mkdir -p /mnt/

root_mounted=0

for path in /dev/*; do
    if [[ $path == *"part"* ]]; then
        /bin/echo "Trying mount $path as root"
        /bin/mount -t ext $path /mnt/
        if [ $? -eq 0 ]; then
            root_mounted=1
            break
        fi
    fi
done

if [ $root_mounted -eq 0 ]; then
    /bin/echo "Mount root failed..."
    exec /bin/sh
fi

/bin/mkdir -p /proc/
/bin/mount -t proc proc /proc
/bin/mkdir -p /sys/
/bin/mount -t sysfs sysfs /sys
/bin/mkdir -p /var/
/bin/mount -t tmpfs tmpfs /var
/bin/mkdir -p /run/
/bin/mount -t tmpfs tmpfs /run
/bin/mkdir -p /tmp/
/bin/mount -t tmpfs tmpfs /tmp

/bin/echo "Ready to switch root..."

export HOME="/root"
export SHELL="/bin/bash"
export XDG_RUNTIME_DIR="/run"
export WLR_RENDERER=pixman
export WLR_RENDERER_ALLOW_SOFTWARE=1
export LIBGL_ALWAYS_SOFTWARE=1
exec /sbin/switch_root /mnt/ /usr/lib/aether/init

